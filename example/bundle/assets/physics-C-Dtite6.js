import{K as X,V as P,W as U,n as N,c as Q,d as Z,D as _,o as $,P as ee,m as te,J as ae,ac as I,M as W,C as j,e as oe,g as ie,h as ne,ad as se,f as re}from"./ExtendedTriangle-CFC-kWKu.js";import{G as de}from"./GLTFLoader-C_LgBif7.js";import{O as ce}from"./OrbitControls-DPxOa-V_.js";import{S as le}from"./stats.min-GTpOrGrX.js";import{g as pe}from"./lil-gui.module.min-jESndyO-.js";import{M as he}from"./MeshBVH-CE-cOGaL.js";import{M as me}from"./MeshBVHHelper-PaFFnbA9.js";import{S as we}from"./StaticGeometryGenerator-C_A6oj1a.js";import"./BufferGeometryUtils-e7tZihaS.js";import"./_commonjsHelpers-Cpj98o6Y.js";const r={displayCollider:!1,displayBVH:!1,displayParents:!1,visualizeDepth:10,gravity:-9.8,physicsSteps:5,simulationSpeed:1,sphereSize:1,pause:!1,step:()=>{const a=r.physicsSteps;for(let i=0;i<a;i++)q(.016/a)},explode:ve,reset:ge};let p,w,h,Y,C,G,S,u,x;const y=[],b=[],l=new X,d=new P,D=new P,fe=new P(0,0,1);ue();A();function ue(){p=new U({antialias:!0}),p.setPixelRatio(window.devicePixelRatio),p.setSize(window.innerWidth,window.innerHeight),p.setClearColor(1251612,1),p.shadowMap.enabled=!0,p.shadowMap.type=N,p.outputEncoding=void 0,document.body.appendChild(p.domElement),h=new Q,h.fog=new Z(1251612,30,70);const i=new _(11193599,1);i.position.set(1,1.5,1).multiplyScalar(50),i.intensity=1.5;const e=i.shadow.camera;e.bottom=e.left=-10,e.top=e.right=10,h.add(i),h.add(new $(9290239,6716557,1.2)),w=new ee(75,window.innerWidth/window.innerHeight,.1,50),w.position.set(10,10,-10),w.far=100,w.updateProjectionMatrix(),window.camera=w,Y=new ne,new ce(w,p.domElement),G=new le,document.body.appendChild(G.dom),ye(),C=new pe;const o=C.addFolder("Visualization");o.add(r,"displayCollider"),o.add(r,"displayBVH"),o.add(r,"displayParents").onChange(c=>{x.displayParents=c,x.update()}),o.add(r,"visualizeDepth",1,20,1).onChange(c=>{x.depth=c,x.update()}),o.open();const t=C.addFolder("Physics");t.add(r,"physicsSteps",0,30,1),t.add(r,"gravity",-100,100,.01).onChange(c=>{r.gravity=parseFloat(c)}),t.add(r,"simulationSpeed",0,5,.01),t.add(r,"sphereSize",.2,5,.1),t.add(r,"pause"),t.add(r,"step"),t.open(),C.add(r,"explode"),C.add(r,"reset"),C.open();const n=new te,m=new ae;let s=0,f=0;p.domElement.addEventListener("pointerdown",c=>{s=c.clientX,f=c.clientY}),p.domElement.addEventListener("pointerup",c=>{if(Math.abs(c.clientX-s)+Math.abs(c.clientY-f)>2)return;m.x=c.clientX/window.innerWidth*2-1,m.y=-(c.clientY/window.innerHeight)*2+1,n.setFromCamera(m,w);const L=O();L.position.copy(w.position).addScaledVector(n.ray.direction,3),L.velocity.set(Math.random()-.5,Math.random()-.5,Math.random()-.5).addScaledVector(n.ray.direction,10*Math.random()+15).multiplyScalar(.5)}),window.addEventListener("resize",function(){w.aspect=window.innerWidth/window.innerHeight,w.updateProjectionMatrix(),p.setSize(window.innerWidth,window.innerHeight)},!1),window.createSphere=O}function ye(){new de().load("https://raw.githubusercontent.com/gkjohnson/3d-demo-data/main/models/low-poly-jungle-scene/scene.gltf",a=>{S=a.scene,S.scale.setScalar(.05);const i=new I(65535,9);i.distance=7,i.position.set(-100,-40,100),S.add(i);const e=new I(16768358,9);e.distance=15,e.intensity=5,e.position.set(80,80,135),e.shadow.normalBias=.01,e.shadow.bias=-.001,e.shadow.mapSize.setScalar(1024),e.castShadow=!0,S.add(e),S.updateMatrixWorld(!0);const o=new we(S);o.attributes=["position"];const t=o.generate();t.boundsTree=new he(t),u=new W(t),u.material.wireframe=!0,u.material.opacity=.5,u.material.transparent=!0,x=new me(u,r.visualizeDepth),h.add(x),h.add(u),h.add(S),S.traverse(n=>{n.material&&(n.castShadow=!0,n.receiveShadow=!0,n.material.shadowSide=2)})})}function k(a,i,e,o,t,n=0){if(t<Math.max(Math.abs(.04*r.gravity),5))return;const m=Math.max(i?Math.max(a.collider.radius,i.collider.radius):a.collider.radius,.4)*2,s=new W(new se(0,1,30),new re({side:2,transparent:!0,depthWrite:!1}));s.lifetime=0,s.maxLifetime=.4,s.maxScale=m*Math.max(Math.sin(Math.min(t/200,1)*Math.PI/2),.35),s.position.copy(e).addScaledVector(o,n),s.quaternion.setFromUnitVectors(fe,o),h.add(s),b.push(s)}function O(){const a=new j(16777215),i=new j(2503224/2).lerp(a,Math.random()*.5+.5),e=new W(new oe(1,20,20),new ie({color:i}));h.add(e),e.castShadow=!0,e.receiveShadow=!0,e.material.shadowSide=2;const o=.5*r.sphereSize*(Math.random()*.2+.6);return e.scale.setScalar(o),e.collider=new X(e.position,o),e.velocity=new P(0,0,0),e.mass=Math.pow(o,3)*Math.PI*4/3,y.push(e),e}function Se(a){const i=u.geometry.boundsTree;for(let e=0,o=y.length;e<o;e++){const t=y[e],n=t.collider;if(t.velocity.y+=r.gravity*a,n.center.addScaledVector(t.velocity,a),n.center.y<-80){y.splice(e,1),e--,o--,t.material.dispose(),t.geometry.dispose(),h.remove(t);continue}l.copy(t.collider);let m=!1;if(i.shapecast({intersectsBounds:s=>s.intersectsSphere(l),intersectsTriangle:s=>{s.closestPointToPoint(l.center,d),d.sub(l.center);const f=d.length();if(f<l.radius){const c=l.radius,z=f-c;d.multiplyScalar(1/f),l.center.addScaledVector(d,z),m=!0}},boundsTraverseOrder:s=>s.distanceToPoint(l.center)-l.radius}),m){d.subVectors(l.center,n.center).normalize(),t.velocity.reflect(d);const s=t.velocity.dot(d);t.velocity.addScaledVector(d,-s*.5),t.velocity.multiplyScalar(Math.max(1-a,0)),n.center.copy(l.center),D.copy(l.center).addScaledVector(d,-l.radius),k(t,null,D,d,s,.05)}}for(let e=0,o=y.length;e<o;e++){const t=y[e],n=t.collider;for(let m=e+1;m<o;m++){const s=y[m],f=s.collider;d.subVectors(n.center,f.center);const c=d.length()-(n.radius+f.radius);if(c<0){d.normalize();const z=t.velocity.dot(d),L=s.velocity.dot(d),B=Math.max(z,.2),R=Math.max(L,.2),T=B+R,J=B/T,K=R/T;n.center.addScaledVector(d,-J*c),f.center.addScaledVector(d,K*c);const g=new P;g.addScaledVector(d,-z).addScaledVector(d,L);const v=g.length(),M=t.mass,V=s.mass;let E,H;const F=.5;g.dot(t.velocity)>g.dot(s.velocity)?(E=F*v*(M-V)/(M+V),H=F*v*2*M/(M+V),E-=v):(E=F*v*2*V/(M+V),H=F*v*(V-M)/(M+V),H-=v),g.normalize(),t.velocity.addScaledVector(g,E),s.velocity.addScaledVector(g,H),D.copy(n.center).addScaledVector(d,-n.radius),k(t,s,D,d,v,0)}}t.position.copy(n.center)}}function ge(){y.forEach(a=>{a.material.dispose(),a.geometry.dispose(),h.remove(a)}),y.length=0,b.forEach(a=>{a.material.dispose(),a.geometry.dispose(),h.remove(a)}),b.length=0}function ve(){const a=new P;y.forEach(i=>{a.copy(i.position),a.y+=10,a.normalize(),i.velocity.addScaledVector(a,120)})}function q(a){if(u){const i=r.physicsSteps;for(let e=0;e<i;e++)Se(a/i)}for(let i=0,e=b.length;i<e;i++){const o=b[i];o.lifetime+=a;const t=o.lifetime/o.maxLifetime;let n=Math.sin(t*4.5*Math.PI/4);n=1-Math.pow(1-n,2),o.scale.setScalar(n*o.maxScale),o.material.opacity=1-Math.sin(t*2*Math.PI/4),t>=1&&(b.splice(i,1),o.parent.remove(o),o.geometry.dispose(),o.material.dispose(),i--,e--)}}function A(){G.update(),requestAnimationFrame(A);const a=Math.min(Y.getDelta(),.1);u&&(u.visible=r.displayCollider,x.visible=r.displayBVH,r.pause||q(r.simulationSpeed*a)),p.render(h,w)}
